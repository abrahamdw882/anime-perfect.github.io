const commentBarrageConfig={lightColors:[["#fcfdff !important","black"]],darkColors:[["#fcfdff !important","white"]],maxBarrage:1,barrageTime:3e3,twikooUrl:"https://twikoo.yuanyuan.blog",accessToken:"90abd7792be5a46a9c501a0bcd159e3f",pageUrl:window.location.pathname,barrageTimer:[],barrageList:[],barrageIndex:0,noAvatarType:"retro",dom:document.querySelector(".comment-barrage"),displayBarrage:!0,avatarCDN:"cravatar.cn"};function checkURL(e){var a=e;return 1==new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/).test(a)}function isInViewPortOfOne(e){const a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return e.offsetTop-document.documentElement.scrollTop<=a}function initCommentBarrage(){var e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl}),a=new XMLHttpRequest;a.withCredentials=!0,a.addEventListener("readystatechange",(function(){4===this.readyState&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data),commentBarrageConfig.dom.innerHTML="")})),a.open("POST",commentBarrageConfig.twikooUrl),a.setRequestHeader("Content-Type","application/json"),a.send(e),timer=setInterval((()=>{console.log(commentBarrageConfig.barrageList),commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())}),commentBarrageConfig.barrageTime)}function commentLinkFilter(e){e.sort(((e,a)=>e.created-a.created));let a=[];return e.forEach((e=>{a.push(...getCommentReplies(e))})),a}function getCommentReplies(e){if(e.replies){let a=[e];return e.replies.forEach((e=>{a.push(...getCommentReplies(e))})),a}return[]}function popCommentBarrage(e){let a=document.createElement("div");commentBarrageConfig.dom.clientWidth,commentBarrageConfig.dom.clientHeight;a.className="comment-barrage-item";let r=Math.floor(Math.random()*commentBarrageConfig.lightColors.length);document.getElementById("barragesColor").innerHTML=`[data-theme='light'] .comment-barrage-item { background-color:${commentBarrageConfig.lightColors[r][0]};color:${commentBarrageConfig.lightColors[r][1]}}[data-theme='dark'] .comment-barrage-item{ background-color:${commentBarrageConfig.darkColors[r][0]};color:${commentBarrageConfig.darkColors[r][1]}}`,null!=e.avatar?null!=e.link?(checkURL(e.link)||(e.link="http://"+e.link),a.innerHTML=`\n            <div class="barrageHead">\n                <img class="barrageAvatar" src="${e.avatar}"/>\n                <a href="${e.link}" class="barrageNick" target="_blank">${e.nick}</a>\n                <a href="javascript:switchCommentBarrage()" style="font-size:20px">×</a>\n            </div>\n            <a class="barrageContent" href="#${e.id}">${e.comment}</a>\n            `):a.innerHTML=`\n            <div class="barrageHead">\n                <img class="barrageAvatar" src="${e.avatar}"/>\n                <div class="barrageNick">${e.nick}</div>\n                <a href="javascript:switchCommentBarrage()" style="font-size:20px">×</a>\n            </div>\n            <a class="barrageContent" href="#${e.id}">${e.comment}</a>\n            `:null!=e.link?(checkURL(e.link)||(e.link="http://"+e.link),a.innerHTML=`\n            <div class="barrageHead">\n                <img class="barrageAvatar" src="https://${commentBarrageConfig.avatarCDN}/avatar/${e.mailMd5}?d=${commentBarrageConfig.noAvatarType}"/>\n                <a href="${e.link}" class="barrageNick" target="_blank">${e.nick}</a>\n                <a href="javascript:switchCommentBarrage()" style="font-size:20px">×</a>\n            </div>\n            <a class="barrageContent" href="#${e.id}">${e.comment}</a>\n            `):a.innerHTML=`\n            <div class="barrageHead">\n                <img class="barrageAvatar" src="https://${commentBarrageConfig.avatarCDN}/avatar/${e.mailMd5}?d=${commentBarrageConfig.noAvatarType}"/>\n                <div class="barrageNick">${e.nick}</div>\n                <a href="javascript:switchCommentBarrage()" style="font-size:20px">×</a>\n            </div>\n            <a class="barrageContent" href="#${e.id}">${e.comment}</a>\n            `,commentBarrageConfig.barrageTimer.push(a),commentBarrageConfig.dom.append(a)}function removeCommentBarrage(e){e.className="comment-barrage-item out",1!=commentBarrageConfig.maxBarrage?setTimeout((()=>{commentBarrageConfig.dom.removeChild(e)}),1e3):commentBarrageConfig.dom.removeChild(e)}-1!=location.href.indexOf("posts")&&(document.onscroll=function(){commentBarrageConfig.displayBarrage&&(isInViewPortOfOne(document.getElementById("post-comment"))?document.getElementsByClassName("comment-barrage")[0].setAttribute("style","display:none;"):document.getElementsByClassName("comment-barrage")[0].setAttribute("style",""))}),switchCommentBarrage=function(){if(localStorage.setItem("isBarrageToggle",Number(!Number(localStorage.getItem("isBarrageToggle")))),!isInViewPortOfOne(document.getElementById("post-comment"))){commentBarrageConfig.displayBarrage=!commentBarrageConfig.displayBarrage;let e=document.querySelector(".comment-barrage");e&&$(e).fadeToggle()}},$(".comment-barrage").hover((function(){clearInterval(timer)}),(function(){timer=setInterval((()=>{commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())}),commentBarrageConfig.barrageTime)})),null==localStorage.getItem("isBarrageToggle")?localStorage.setItem("isBarrageToggle","0"):"1"==localStorage.getItem("isBarrageToggle")&&(localStorage.setItem("isBarrageToggle","0"),switchCommentBarrage()),initCommentBarrage();